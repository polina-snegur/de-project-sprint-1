Кирилл, привет!

Спасибо за комментраии. 

1. Исправила datamart_ddl.sql, добавив drop. Также добавила check для значений факторов, упустила столь важный момент в первый раз.
2. Совсем забыла про оконные функции. Разбивала пользователей на +/- ровные группы по гистограммам и % от общего количества в Excel))

Раньше считала, что оконные функции не работают вместе с группировкой. У тебя работает все) Почитаю интернет про это.

SELECT 
    u.id AS user_id,
    ntile(5) OVER (ORDER BY sum(o.payment) NULLS FIRST) AS monetary_value
FROM 
    analysis.users AS u
LEFT JOIN
    analysis.orders AS o 
        ON u.id = o.user_id
        AND o.status = (SELECT id FROM analysis.orderstatuses WHERE key = 'Closed')
        AND EXTRACT (YEAR FROM o.order_ts) >= 2022
GROUP BY u.id

Кирилл, тут вопрос по LEFT JOIN.
Если условия про 'Closed' и EXTRACT (YEAR FROM o.order_ts) >= 2022 вынести в WHERE блок, то это уже будет не LEFT, а INNER JOIN?

И вопрос про сам смысл LEFT JOIN к таблице с клиентами. Подумала, что цель витрины не насчитать метрики на всех подряд клиентов, а только на тех, кто совершал хотя бы один заказ. Иначе по части клиентов просто будут пустые значения. И это значит, что NTILE здесь cработает не совсем корректно. 1 может присвоится клиенту с пустым значением метрики.

Проверила, что такого нет, но на практике быть может.
SELECT *
FROM analysis.v_users vu 
LEFT JOIN analysis.v_orders vo ON vo.user_id = vu.id 
WHERE vo.order_id IS NULL AND vo.status = 4; -- Closed

RFM-сегментация строитcя на основе заказов. Может быть для тех клиентов, у кого еще не было заказов, присваивать всем метрикам 0 (или другую константу), считать их за новичков и направлять чуть другие маркетинговые усилия. 

У меня был опыт работы аналитиком в direct marketing (торговля по каталогам). Бизнес был полностью построен на RFM сегментации. И такие "новички" в базе действительно появлялись, когда похожий по направлению бизнес продавал часть своих "спящих клиентов". Они появлялись в нашей базе и со временем становились клиентами, если повезет.
