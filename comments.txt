Кирилл, привет!

Спасибо за комментраии. 

1. Исправила datamart_ddl.sql, добавив drop. Также добавила check для значений факторов, упустила столь важный момент в первый раз.
2. Совсем забыла про оконные функции. Разбивала пользователей на +/- ровные группы по гистограммам и % от общего количества в Excel))

Раньше считала, что оконные функции не работают вместе с группировкой. У тебя работает все) Почитаю интернет про это.

SELECT 
    u.id AS user_id,
    ntile(5) OVER (ORDER BY sum(o.payment) NULLS FIRST) AS monetary_value
FROM 
    analysis.users AS u
LEFT JOIN
    analysis.orders AS o 
        ON u.id = o.user_id
        AND o.status = (SELECT id FROM analysis.orderstatuses WHERE key = 'Closed')
        AND EXTRACT (YEAR FROM o.order_ts) >= 2022
GROUP BY u.id

Кирилл, тут вопрос по LEFT JOIN.
Если условия про 'Closed' и EXTRACT (YEAR FROM o.order_ts) >= 2022 вынести в WHERE блок, то это уже будет не LEFT, а INNER JOIN? Каждый раз не понимала подобный момент, когда дата инженер на работе на это явно указывал в моих процедурах при ревью. А здесь поняла наконец-то!

И вопрос про сам смысл LEFT JOIN к таблице с клиентами. Исправила, как у тебя, но добавила еще order_id IS NOT NULL в WHERE-блок.
Подумала, что цель витрины не насчитать метрики на всех подряд клиентов, а только на тех, кто совершал хотя бы один успешный заказ. Иначе по части клиентов просто будут пустые значения. И это значит, что NTILE здесь cработает не совсем корректно. Флаг 1 может присвоится клиенту с пустым значением метрики.

Проверила, что это действительно так (создала 3 tmp_rfm таблицы без условия по order_id в WHERE). 
SELECT *
FROM analysis.v_users u
LEFT JOIN analysis.v_orders vo ON vo.user_id = u.id AND vo.status = 4
WHERE order_id IS NULL
ORDER BY 1;

SELECT *
FROM analysis.dm_rfm_segments drs 
WHERE user_id = 211;

Клиент с user_id = 211 не совершал ни одного успешного заказа (все отменил), но на него насчитались метрики, чего быть не должго.

3. По причине выше не стала делать LEFT JOIN к таблице с клиентами при формировании витрины. Подстраховалась лишь LEFT JOIN таблиц с метриками на тех клиентов, кто в orders имеет успешные заказы за 2022 год. Хотя это делать необязательно, ведь метрики и считались на таких клиентов.

RFM-сегментация строитcя на основе заказов. Если у бизнеса есть желание видеть всех клиентов, то на тем клиентам, у кого еще не было успешных заказов, можно присваивать флаг 0 (или другую константу), считать их за потенциальных новичков и направлять чуть другие маркетинговые усилия (специальные предложения или скидки). 

У меня был опыт работы аналитиком в direct marketing (торговля по каталогам). Бизнес был полностью построен на RFM сегментации. И чем-то схожие "новички" в базе действительно появлялись, когда похожий по направлению бизнес продавал часть своих "спящих клиентов". Они появлялись в нашей базе и со временем становились клиентами, если повезет.

Как-то так)